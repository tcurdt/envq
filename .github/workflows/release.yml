name: release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    name: build-${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - target: aarch64-apple-darwin
            os: macos-latest
            homebrew_arch: darwin-arm64
          # - target: x86_64-apple-darwin
          #   os: macos-13
          #   homebrew_arch: darwin-amd64
          # - target: x86_64-unknown-linux-musl
          #   os: ubuntu-latest
          #   homebrew_arch: linux-amd64
          # - target: aarch64-unknown-linux-musl
          #   os: ubuntu-latest
          #   homebrew_arch: linux-arm64
          #   use-cross: true
    steps:
      - uses: actions/checkout@v6

      - name: install rust
        uses: dtolnay/rust-toolchain@1.92.0
        with:
          targets: ${{ matrix.target }}

      - name: install cross
        if: matrix.use-cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: build
        run: ${{ matrix.use-cross && 'cross' || 'cargo' }} build --release --target ${{ matrix.target }}

      - name: create archive
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          cd target/${{ matrix.target }}/release
          tar czf ../../../envq-${VERSION}-${{ matrix.homebrew_arch }}.tar.gz envq

      - name: upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: envq-${{ matrix.target }}
          path: envq-*-${{ matrix.homebrew_arch }}.tar.gz

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: download artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: envq-*
          merge-multiple: true

      - name: create release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create ${{ github.ref_name }} \
            --title ${{ github.ref_name }} \
            --generate-notes \
            envq-*.tar.gz

  homebrew:
    needs: release
    runs-on: ubuntu-latest
    environment: release
    steps:
      - name: update homebrew tap
        uses: Justintime50/homebrew-releaser@v3
        with:
          homebrew_owner: tcurdt
          homebrew_tap: homebrew-tap
          formula_folder: Formula
          github_token: ${{ secrets.PAT_RELEASE }}
          target_darwin_arm64: true
          # target_darwin_amd64: true
          # target_linux_arm64: true
          # target_linux_amd64: true
          install: |
            bin.install "envq"
          test: |
            assert_match "envq", shell_output("#{bin}/envq --help")

            (testpath/"test.env").write("KEY=value\n")
            assert_equal "value", shell_output("#{bin}/envq get KEY test.env").strip
